-- KaiTun Farm Fruits 2025 - DÙNG dark-dark, rocket-rocket
repeat wait() until game:IsLoaded()
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer

_G.KaitunFarm = _G.KaitunFarm or {
    mythic = true, legen = true, epic = false, rare = false,
    autoStore = true, hopWhenEmpty = true, notifyRare = true,
    flySpeed = 350, randomFly = true, antiBan = true
}

-- DANH SÁCH TRÁI: DÙNG dark-dark, rocket-rocket, spin-spin...
local Fruits = {
    Mythical = {"kitsune-kitsune", "dragon-dragon", "leopard-leopard", "t-rex-t-rex", "venom-venom", "dough-dough", "shadow-shadow", "spirit-spirit", "control-control", "gravity-gravity"},
    Legendary = {"magma-magma", "light-light", "dark-dark", "ice-ice", "rumble-rumble", "phoenix-phoenix", "buddha-buddha", "quake-quake", "love-love", "spider-spider", "sound-sound", "pain-pain", "blizzard-blizzard"},
    Epic = {"flame-flame", "sand-sand", "diamond-diamond", "portal-portal", "revive-revive", "barrier-barrier", "mammoth-mammoth", "yeti-yeti", "falcon-falcon", "ope-ope", "gas-gas", "spin-spin"},
    Rare = {"bomb-bomb", "spike-spike", "chop-chop", "spring-spring", "kilo-kilo", "smoke-smoke", "rubber-rubber", "rocket-rocket"}
}

-- CHUYỂN TÊN THẬT → TÊN DẠNG "xxx-xxx"
local function toDoubleName(name)
    name = name:lower()
    return name .. "-" .. name
end

-- LẤY TÊN TRÁI THẬT TỪ Fruit.Value
local function getRealFruitName(model)
    local fruit = model:FindFirstChild("Fruit")
    if fruit and fruit:IsA("StringValue") then
        return fruit.Value
    end
    return nil
end

-- TÌM TRONG DANH SÁCH (dùng tên kép)
local function getRarity(doubleName)
    for r, list in pairs(Fruits) do
        if table.find(list, doubleName) then
            return r
        end
    end
    return nil
end

-- === ANTIBAN + DELAY ===
local function randWait(min, max)
    wait(_G.KaitunFarm.antiBan and math.random(min*10, max*10)/10 or (min+max)/2)
end

-- === BAY MƯỢT + NGẪU NHIÊN ===
local function flyTo(model)
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")
    local handle = model:FindFirstChild("Handle")
    if not handle then return end

    local pos = handle.Position + Vector3.new(0, 5, 0)
    if _G.KaitunFarm.randomFly then
        pos = pos + Vector3.new(math.random(-4,4), math.random(1,6), math.random(-4,4))
    end

    local dist = (hrp.Position - pos).Magnitude
    local time = math.max(0.1, dist / _G.KaitunFarm.flySpeed)
    local tween = TweenService:Create(hrp, TweenInfo.new(time * math.random(90,110)/100, Enum.EasingStyle.Linear), {CFrame = CFrame.new(pos)})
    tween:Play()
    tween.Completed:Wait()
    randWait(0.3, 0.6)
end

-- === NHẶT + CẤT ===
local function collectAndStore(model, realName)
    local handle = model:FindFirstChild("Handle")
    if not handle then return false end
    local cd = handle:FindFirstChildOfClass("ClickDetector")
    if cd then
        fireclickdetector(cd)
        randWait(0.4, 0.7)
        if _G.KaitunFarm.autoStore then
            pcall(function()
                ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", realName, "Store")
            end)
        end
        return true
    end
    return false
end

-- === AUTO HOP + ANTI-AFK ===
local lastFruit = tick()
spawn(function()
    while wait(25) do
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
        if _G.KaitunFarm.hopWhenEmpty and tick() - lastFruit > 120 then
            StarterGui:SetCore("SendNotification", {Title="KaiTun", Text="Hết trái → Hop server!", Duration=3})
            wait(1.5)
            TeleportService:Teleport(game.PlaceId)
        end
    end
end)

-- === CHẠY CHÍNH ===
spawn(function()
    while wait(0.25) do
        if not (_G.KaitunFarm.mythic or _G.KaitunFarm.legen or _G.KaitunFarm.epic or _G.KaitunFarm.rare) then continue end

        for _, obj in pairs(Workspace:GetChildren()) do
            if obj:IsA("Model") and obj.Name:match("-Fruit$") and obj:FindFirstChild("Handle") and obj:FindFirstChild("Fruit") then
                local realName = getRealFruitName(obj)
                if not realName then continue end

                local doubleName = toDoubleName(realName)  -- Ví dụ: "Rocket" → "rocket-rocket"
                local rarity = getRarity(doubleName)
                if not rarity then continue end

                local shouldFarm = 
                    (_G.KaitunFarm.mythic and rarity == "Mythical") or
                    (_G.KaitunFarm.legen and rarity == "Legendary") or
                    (_G.KaitunFarm.epic and rarity == "Epic") or
                    (_G.KaitunFarm.rare and rarity == "Rare")

                if shouldFarm then
                    lastFruit = tick()
                    flyTo(obj)
                    if collectAndStore(obj, realName) and _G.KaitunFarm.notifyRare then
                        StarterGui:SetCore("SendNotification", {
                            Title = rarity:upper() .. "!",
                            Text = realName .. " ("..doubleName..") → ĐÃ CẤT!",
                            Duration = 8
                        })
                    end
                    randWait(0.7, 1.5)
                    break
                end
            end
        end
    end
end)

-- === THÔNG BÁO ===
StarterGui:SetCore("SendNotification", {
    Title = "KaiTun Ultra",
    Text = "Dùng dark-dark, rocket-rocket → ĐÃ HOẠT ĐỘNG!",
    Duration = 8
})
